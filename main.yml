AWSTemplateFormatVersion: "2010-09-09"
Description: Creates a SAML Identity Provider.
Parameters:
  mspPrefix:
    Description: Prefix to use for the MSP branding.
    Type: String
    Default: "NMD"
  freesideCoreAWSAccountId:
    Description: AWS Account id of the Freeside deployment service.
    Type: String
  freesideCoreExternalId:
    Type: String
    Description: External Id to use with this customer. Should be generated by the MSP.
  idpName:
    Description: Name of the identity provider to create.
    Type: String
    Default: "GSuite"
  samlMetadata:
     Type: String
Resources:
  samlIdentityProvider:
    Type: AWS::IAM::SAMLProvider
    Properties: 
      Name: !Ref idpName
      SamlMetadataDocument: !Ref samlMetadata
  FreesideAdminRole:
    Type: AWS::IAM::Role
    Properties: 
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: 
              Federated: !Sub "arn:aws:iam::${AWS::AccountId}:saml-provider/${idpName}"
            Action:
              - "sts:AssumeRoleWithSAML"
            Condition:
              StringEquals:
                "SAML:aud": "https://signin.aws.amazon.com/saml"
      Description: !Sub "${mspPrefix} Admin Role for service."
      RoleName: !Sub "${mspPrefix}-Freeside-Admin"
    DependsOn: samlIdentityProvider
  FreesideDeploymentRole:
    Type: AWS::IAM::Role
    Properties: 
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: 
              AWS: !Sub "${freesideCoreAWSAccountId}"
            Action:
              - "sts:AssumeRole"
            Condition:
              StringEquals:
                "sts:ExternalId": !Sub "${freesideCoreExternalId}"
      Description: !Sub "${mspPrefix} Admin Role for service."
      RoleName: !Sub "${mspPrefix}-Freeside-Deployment"
    DependsOn: samlIdentityProvider
  FreesideDeploymentPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: FreesideDeploymentPolicy
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action: [
              'iam:*',
            ]
            Resource: 
              - !Sub "arn:aws:iam::${AWS::AccountId}:role/freeside/*"
              - !Sub "arn:aws:iam::${AWS::AccountId}:policy/freeside/*"
              - !Sub "arn:aws:iam::${AWS::AccountId}:instance-profile/freeside/*"
          - Effect: Allow
            Action: [
              'amplify:*',
              'athena:*',
              'ec2:*',
              'elasticmapreduce:*',
              'glue:*',
              's3:*',
            ]
            Resource: "*"
      Roles: 
        - Ref: "FreesideAdminRole"
        - Ref: "FreesideDeploymentRole"